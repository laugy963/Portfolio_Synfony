name: Tests

# D√©clencher les tests sur push et pull request
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    
    # Services n√©cessaires (base de donn√©es PostgreSQL)
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: "!ChangeMe!"
          POSTGRES_USER: app
          POSTGRES_DB: app_test
        options: >-
          --health-cmd "pg_isready -U app"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    # 1. R√©cup√©rer le code source
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Configurer PHP
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, dom, filter, gd, json, pgsql
        coverage: none

    # 3. Valider le composer.json
    - name: Validate composer.json
      run: composer validate --strict

    # 4. Cache des d√©pendances Composer
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    # 5. Installer les d√©pendances
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest --no-interaction

    # 5.5. Attendre que la base de donn√©es soit pr√™te
    - name: Wait for database to be ready
      run: |
        for i in {1..30}; do
          if pg_isready -h 127.0.0.1 -p 5432 -U app; then
            echo "‚úÖ Base de donn√©es pr√™te"
            break
          fi
          echo "‚è≥ Attente de la base de donn√©es... ($i/30)"
          sleep 2
        done

    # 6. Configurer l'environnement de test
    - name: Setup test environment
      run: |
        cp .env.test .env.test.local
        # Configuration DATABASE_URL explicite pour √©viter les suffixes automatiques
        echo "DATABASE_URL=postgresql://app:!ChangeMe!@127.0.0.1:5432/app_test?serverVersion=16&charset=utf8" >> .env.test.local
        echo "MAILER_DSN=null://null" >> .env.test.local
        echo "MAILER_FROM_EMAIL=test@example.com" >> .env.test.local
        echo 'MAILER_FROM_NAME="Test Service"' >> .env.test.local
        
        # V√©rifier la configuration DATABASE_URL
        echo "üîç Configuration de la base de donn√©es:"
        grep "DATABASE_URL" .env.test.local

    # 7. V√©rifier la configuration Doctrine
    - name: üîç Check Doctrine configuration
      run: |
        echo "üìã Configuration Doctrine dans l'environnement de test:"
        php bin/console debug:config doctrine dbal --env=test | head -20

    # 8. Cr√©er la base de donn√©es et les tables
    - name: üóÑÔ∏è Create database
      run: |
        # Attendre que PostgreSQL soit compl√®tement pr√™t
        for i in {1..10}; do
          if PGPASSWORD="!ChangeMe!" psql -h 127.0.0.1 -U app -d postgres -c "SELECT 1;" >/dev/null 2>&1; then
            echo "‚úÖ PostgreSQL est pr√™t"
            break
          fi
          echo "‚è≥ Attente PostgreSQL... ($i/10)"
          sleep 2
        done
        
        # Supprimer et recr√©er les bases de donn√©es pour √©viter les conflits
        echo "üóëÔ∏è Suppression des bases existantes..."
        PGPASSWORD="!ChangeMe!" psql -h 127.0.0.1 -U app -d postgres -c "DROP DATABASE IF EXISTS app_test;" || echo "app_test n'existait pas"
        PGPASSWORD="!ChangeMe!" psql -h 127.0.0.1 -U app -d postgres -c "DROP DATABASE IF EXISTS app;" || echo "app n'existait pas"
        
        echo "üèóÔ∏è Cr√©ation des nouvelles bases..."
        PGPASSWORD="!ChangeMe!" psql -h 127.0.0.1 -U app -d postgres -c "CREATE DATABASE app_test;"
        PGPASSWORD="!ChangeMe!" psql -h 127.0.0.1 -U app -d postgres -c "CREATE DATABASE app;"
        
        # V√©rifier que la base de test est accessible
        echo "‚úÖ V√©rification de l'acc√®s √† app_test..."
        PGPASSWORD="!ChangeMe!" psql -h 127.0.0.1 -U app -d app_test -c "SELECT version();"
        
        # Cr√©er et migrer via Symfony (pour la base de test)
        echo "üîÑ Ex√©cution des migrations..."
        php bin/console doctrine:migrations:migrate --no-interaction --env=test

    # 9. Charger les fixtures (donn√©es de test)
    - name: Load fixtures
      run: php bin/console doctrine:fixtures:load --env=test --no-interaction

    # 10. Lancer tous les tests PHPUnit
    - name: Run PHPUnit tests
      run: php bin/phpunit --testdox

    # 11. V√©rifier la qualit√© du code (optionnel)
    - name: Check coding standards (optional)
      run: |
        if [ -f "vendor/bin/php-cs-fixer" ]; then
          vendor/bin/php-cs-fixer fix --dry-run --diff
        else
          echo "PHP CS Fixer not installed, skipping..."
        fi
      continue-on-error: true

    env:
      ADMIN_EMAIL: "test@example.com"
      ADMIN_FIRSTNAME: "Test"
      ADMIN_LASTNAME: "User"
      ADMIN_PASSWORD: "dummy_password"
